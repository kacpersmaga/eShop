@{
    ViewData["Title"] = "Confirm Phone 2FA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Confirm Phone Two-Factor Authentication</h2>

<p>A verification code has been sent to your phone. Please enter it below to complete setup:</p>

<form id="confirmPhone2faForm">
    <div>
        <label for="code">Verification Code</label>
        <input type="text" id="code" name="code" required />
    </div>
    <button type="submit">Confirm Phone 2FA</button>
</form>

<div id="message" style="margin-top: 15px;"></div>

<script>
    document.getElementById('confirmPhone2faForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const code = document.getElementById('code').value;
        const xsrfToken = getCookie('XSRF-TOKEN');

        try {
            const response = await fetch('/api/auth/enable-2fa/confirm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': xsrfToken
                },
                credentials: 'include',
                body: JSON.stringify({ code })
            });

            const result = await response.json();

            const messageEl = document.getElementById('message');
            if (response.ok) {
                messageEl.style.color = 'green';
                messageEl.innerText = result.message || 'Phone 2FA has been successfully enabled.';
                setTimeout(() => {
                    window.location.href = "/Account/Profile";  // Redirect to profile or dashboard
                }, 2000);
            } else {
                messageEl.style.color = 'red';
                messageEl.innerText = result.message || 'Failed to verify code.';
            }
        } catch (error) {
            document.getElementById('message').innerText = 'An error occurred. Please try again.';
            document.getElementById('message').style.color = 'red';
        }
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(';').shift() : "";
    }
</script>