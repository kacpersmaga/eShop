@{
    ViewData["Title"] = "Change Password";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Change Password</h2>

<div class="row">
    <div class="col-md-6">
        <form id="changePasswordForm">
            <div id="message" style="margin-bottom: 15px;"></div>
            
            <div class="form-group mb-3">
                <label for="currentPassword">Current Password</label>
                <input type="password" class="form-control" id="currentPassword" name="currentPassword" required />
            </div>
            
            <div class="form-group mb-3">
                <label for="newPassword">New Password</label>
                <input type="password" class="form-control" id="newPassword" name="newPassword" required />
            </div>
            
            <div class="form-group mb-3">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required />
            </div>
            
            <button type="submit" class="btn btn-primary">Change Password</button>
            <a href="/Account/Profile" class="btn btn-secondary ms-2">Cancel</a>
        </form>
    </div>
</div>

<script>
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageEl = document.getElementById('message');
        
        if (newPassword !== confirmPassword) {
            messageEl.innerText = "New passwords do not match";
            messageEl.className = "alert alert-danger";
            return;
        }
        
        const xsrfToken = getCookie('XSRF-TOKEN');
        
        try {
            const response = await fetch('/api/user/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': xsrfToken
                },
                credentials: 'include',
                body: JSON.stringify({
                    currentPassword,
                    newPassword,
                    confirmPassword
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                messageEl.innerText = "Password changed successfully";
                messageEl.className = "alert alert-success";
                document.getElementById('changePasswordForm').reset();
            } else {
                messageEl.innerText = result.message || "Failed to change password";
                messageEl.className = "alert alert-danger";
            }
        } catch (error) {
            messageEl.innerText = "An error occurred. Please try again.";
            messageEl.className = "alert alert-danger";
        }
    });
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(';').shift() : "";
    }
</script>