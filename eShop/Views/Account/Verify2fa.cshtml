<h2>Two-Factor Authentication Verification</h2>

<p>Please enter the authentication code sent to your registered method:</p>

<form id="verify2faForm">
    <div>
        <label for="userName">User Name</label>
        <input type="text" id="userName" name="userName" required />
    </div>
    <div>
        <label for="code">Authentication Code</label>
        <input type="text" id="code" name="code" required />
    </div>
    <button type="submit">Verify</button>
    <button type="button" id="resendCode">Resend Code</button>
</form>

<div id="message" style="color:red; margin-top:10px;"></div>

<script>
    const pendingUserName = localStorage.getItem("pendingUserName");
    if (pendingUserName) {
        document.getElementById("userName").value = pendingUserName;
        document.getElementById("userName").readOnly = true;
        send2faCode(pendingUserName); // Auto-send code on page load
    }

    async function send2faCode(userName) {
        const xsrfToken = getCookie('XSRF-TOKEN');
        try {
            const response = await fetch('/api/auth/send-2fa-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': xsrfToken
                },
                credentials: 'include',
                body: JSON.stringify({ userName })
            });
            const result = await response.json();
            document.getElementById('message').style.color = response.ok ? 'green' : 'red';
            document.getElementById('message').innerText = result.message;
        } catch (error) {
            document.getElementById('message').innerText = 'Error sending code';
        }
    }

    document.getElementById('verify2faForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const userName = document.getElementById('userName').value;
        const code = document.getElementById('code').value;
        const xsrfToken = getCookie('XSRF-TOKEN');

        try {
            const response = await fetch('/api/auth/verify-2fa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': xsrfToken
                },
                credentials: 'include',
                body: JSON.stringify({ userName, code })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById('message').style.color = 'green';
                document.getElementById('message').innerText = 'Verification successful. Redirecting...';
                localStorage.setItem("refreshToken", result.refreshToken);
                localStorage.removeItem("pendingUserName");
                setTimeout(() => { window.location.href = "/"; }, 2000);
            } else {
                document.getElementById('message').innerText = result.message || 'Verification failed';
            }
        } catch (error) {
            document.getElementById('message').innerText = 'Error verifying code';
        }
    });

    document.getElementById('resendCode').addEventListener('click', function() {
        const userName = document.getElementById('userName').value;
        if (userName) {
            send2faCode(userName);
        }
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return "";
    }
</script>